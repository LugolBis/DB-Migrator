{
    "tables":[
       {
          "table_name":"auteurs",
          "columns":[
             {
                "column_name":"auteur_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":"nextval('auteurs_auteur_id_seq'::regclass)",
                "primary_key":true,
                "foreign_key":null
             },
             {
                "column_name":"nom",
                "data_type":"character varying",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             },
             {
                "column_name":"nationalite",
                "data_type":"character varying",
                "is_nullable":"YES",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             }
          ]
       },
       {
          "table_name":"categories",
          "columns":[
             {
                "column_name":"categorie_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":"nextval('categories_categorie_id_seq'::regclass)",
                "primary_key":true,
                "foreign_key":null
             },
             {
                "column_name":"nom",
                "data_type":"character varying",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             }
          ]
       },
       {
          "table_name":"editeurs",
          "columns":[
             {
                "column_name":"editeur_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":"nextval('editeurs_editeur_id_seq'::regclass)",
                "primary_key":true,
                "foreign_key":null
             },
             {
                "column_name":"nom",
                "data_type":"character varying",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             },
             {
                "column_name":"adresse",
                "data_type":"character varying",
                "is_nullable":"YES",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             }
          ]
       },
       {
          "table_name":"livres",
          "columns":[
             {
                "column_name":"livre_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":"nextval('livres_livre_id_seq'::regclass)",
                "primary_key":true,
                "foreign_key":null
             },
             {
                "column_name":"titre",
                "data_type":"character varying",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             },
             {
                "column_name":"auteur_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":[
                   {
                      "constraint_name":"livres_auteur_id_fkey",
                      "referenced_table":"auteurs",
                      "referenced_column":"auteur_id"
                   }
                ]
             },
             {
                "column_name":"date_publication",
                "data_type":"date",
                "is_nullable":"YES",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             },
             {
                "column_name":"isbn",
                "data_type":"character varying",
                "is_nullable":"YES",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             },
             {
                "column_name":"categorie_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":[
                   {
                      "constraint_name":"livres_categorie_id_fkey",
                      "referenced_table":"categories",
                      "referenced_column":"categorie_id"
                   }
                ]
             },
             {
                "column_name":"editeur_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":[
                   {
                      "constraint_name":"livres_editeur_id_fkey",
                      "referenced_table":"editeurs",
                      "referenced_column":"editeur_id"
                   }
                ]
             }
          ]
       },
       {
          "table_name":"exemplaires",
          "columns":[
             {
                "column_name":"exemplaire_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":"nextval('exemplaires_exemplaire_id_seq'::regclass)",
                "primary_key":true,
                "foreign_key":null
             },
             {
                "column_name":"livre_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":[
                   {
                      "constraint_name":"exemplaires_livre_id_fkey",
                      "referenced_table":"livres",
                      "referenced_column":"livre_id"
                   }
                ]
             },
             {
                "column_name":"statut",
                "data_type":"character varying",
                "is_nullable":"YES",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             }
          ]
       },
       {
          "table_name":"utilisateurs",
          "columns":[
             {
                "column_name":"utilisateur_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":"nextval('utilisateurs_utilisateur_id_seq'::regclass)",
                "primary_key":true,
                "foreign_key":null
             },
             {
                "column_name":"prenom",
                "data_type":"character varying",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             },
             {
                "column_name":"nom",
                "data_type":"character varying",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             },
             {
                "column_name":"email",
                "data_type":"character varying",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             },
             {
                "column_name":"date_inscription",
                "data_type":"date",
                "is_nullable":"YES",
                "column_default":"CURRENT_DATE",
                "primary_key":null,
                "foreign_key":null
             }
          ]
       },
       {
          "table_name":"emprunts",
          "columns":[
             {
                "column_name":"emprunt_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":"nextval('emprunts_emprunt_id_seq'::regclass)",
                "primary_key":true,
                "foreign_key":null
             },
             {
                "column_name":"utilisateur_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":[
                   {
                      "constraint_name":"emprunts_utilisateur_id_fkey",
                      "referenced_table":"utilisateurs",
                      "referenced_column":"utilisateur_id"
                   }
                ]
             },
             {
                "column_name":"exemplaire_id",
                "data_type":"integer",
                "is_nullable":"NO",
                "column_default":null,
                "primary_key":null,
                "foreign_key":[
                   {
                      "constraint_name":"emprunts_exemplaire_id_fkey",
                      "referenced_table":"exemplaires",
                      "referenced_column":"exemplaire_id"
                   }
                ]
             },
             {
                "column_name":"date_emprunt",
                "data_type":"date",
                "is_nullable":"NO",
                "column_default":"CURRENT_DATE",
                "primary_key":null,
                "foreign_key":null
             },
             {
                "column_name":"date_retour",
                "data_type":"date",
                "is_nullable":"YES",
                "column_default":null,
                "primary_key":null,
                "foreign_key":null
             }
          ]
       }
    ],
    "triggers":[
       {
          "trigger_name":"disponible",
          "event":"CREATE TRIGGER disponible BEFORE INSERT ON public.emprunts FOR EACH ROW EXECUTE FUNCTION verifier_disponibilite()",
          "table_name":"emprunts"
       }
    ],
    "procedures":[
       {
          "procedure_name":"retour",
          "return_type":"void",
          "arguments":null,
          "definition":"CREATE OR REPLACE PROCEDURE public.retour(IN exemplaire_id integer)\n LANGUAGE plpgsql\nAS $procedure$\nbegin\n    update exemplaires set statut=\"disponible\" where exemplaire_id=exemplaire_id;\nend;\n$procedure$\n"
       }
    ],
    "functions":[
       {
          "function_name":"export_db_to_json",
          "return_type":"jsonb",
          "arguments":"jsonb",
          "definition":"CREATE OR REPLACE FUNCTION public.export_db_to_json()\n RETURNS jsonb\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  rec record;\n  table_json jsonb;\n  result jsonb := '{}'::jsonb;\nBEGIN\n  FOR rec IN\n    SELECT table_schema, table_name\n    FROM information_schema.tables\n    WHERE table_schema NOT IN ('pg_catalog', 'information_schema')\n      AND table_name NOT IN ('users', 'technical_details', 'metadata')\n  LOOP\n    EXECUTE format(\n      'SELECT COALESCE(JSONB_AGG(ROW_TO_JSON(t)::jsonb), ''[]''::jsonb) FROM %I.%I t',\n      rec.table_schema, rec.table_name\n    )\n    INTO table_json;\n    \n    result := result || jsonb_build_object(rec.table_name, table_json);\n  END LOOP;\n  \n  RETURN result;\nEND;\n$function$\n"
       },
       {
          "function_name":"verifier_disponibilite",
          "return_type":"trigger",
          "arguments":"trigger",
          "definition":"CREATE OR REPLACE FUNCTION public.verifier_disponibilite()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\ndeclare\n    DISPONIBILITE varchar(20);\nbegin\n    select statut into DISPONIBILITE\n    from exemplaires\n    where exemplaire_id = new.exemplaire_id;\n\n    if DISPONIBILITE = 'disponible' then\n        update exemplaires \n        set statut = 'emprunt\u00e9' \n        where exemplaire_id = new.exemplaire_id;\n    else\n        RAISE EXCEPTION 'The book % is already borrowed.', new.exemplaire_id;\n    end if;\n\n    return new;\nend;\n$function$\n"
       }
    ]
}